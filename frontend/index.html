<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>luce.finance Bridge</title>
  <p style="
  text-align: center;
  font-size: 13px;
  margin: 0 0 18px 0;
  color: var(--text);
  opacity: 0.85;
  line-height: 1.5;
">
  Bridge requests are <strong>manually verified</strong> for security reasons.  
  Please allow up to <strong>24 hours</strong> for completion after submission.
</p>

  <style>
  /* ================= Theme Colors ================= */
  :root {
    --bg: rgb(245, 249, 255);
    --card: #ffffff;
    --text: #1f2937;
    --border: #d0d7e2;

    --primary: #2563eb;
    --primary-hover: #1e40af;

    --input-bg: #ffffff;
    --input-text: #1f2937;
    --input-border: #c7d2fe;
  }

  [data-theme="dark"] {
    --bg: rgb(37, 43, 52);
    --card: #1e2630;
    --text: #e5e7eb;
    --border: #2f3a46;

    --primary: #3b82f6;
    --primary-hover: #2563eb;

    --input-bg: #2a3441;
    --input-text: #e5e7eb;
    --input-border: #3b4756;
  }

  /* ================= General ================= */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: clamp(12px, 3vw, 24px);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  .container { max-width: min(92vw, 720px); margin: auto; }
  h2 { text-align: center; font-size: clamp(1.5rem, 4vw, 2.2rem); margin-top: 0; margin-bottom: 16px; }
  h3 { text-align: center; font-size: clamp(1.1rem, 3vw, 1.4rem); margin-top: 0; margin-bottom: 16px; }

  .box {
    background: var(--card);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
    width: 100%;
    transition: transform .3s ease, opacity .3s ease, background .3s ease;
  }

  input, select {
    width: 100%;
    font-size: clamp(16px, 2.6vw, 18px);
    padding: 14px;
    margin-top: 12px;
    border-radius: 10px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--input-text);
  }

  select option {
    background: var(--card);
    color: var(--text);
  }

  button {
    display: inline-block;
    font-size: 14px;
    font-weight: 500;
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--primary);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    margin-top: 12px;
  }

  button:hover { background: var(--primary-hover); }

  .copy-btn {
    width: auto;
    display: block;
    margin: 12px auto 0 auto;
    text-align: center;
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--primary);
    color: #fff;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
  }

  .copy-btn:hover { background: var(--primary-hover); }

  .theme-button {
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--primary);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 auto 20px auto;
    display: block;
    width: auto;
  }

  .theme-button:hover { background: var(--primary-hover); }

  .hidden { display: none !important; opacity: 0; transform: translateY(10px); }
  .show { display: block !important; opacity: 1; transform: translateY(0); }

  #stage2 {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #destination {
    text-align: center;
    font-weight: bold;
    margin-top: 10px;
    word-break: break-all;
  }

  #stage2 img {
    display: block;
    margin: 16px auto 20px auto;
    width: min(60vw, 180px);
  }

  #stage2 input { width: 100%; }

  #statusResult {
    margin-top: 12px;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--card);
    white-space: pre-wrap;
    word-break: break-all;
    width: 100%;
  }

  .pending { background: #fff3cd !important; }
  .completed { background: #d4edda !important; }
  </style>
</head>

<body>
<div class="container">

  <button class="theme-button" id="themeButton" onclick="toggleTheme()">Dark Mode</button>

  <h2>luce.finance Bridge</h2>

  <!-- Stage 1 -->
  <div class="box show" id="stage1">
    <select id="asset">
      <option value="">Select Asset</option>
      <option value="USDT">USDT (Binance Smart Chain → Electra Protocol)</option>
      <option value="LUSDT">LUSDT (Electra Protocol → Binance Smart Chain)</option>
    </select>

    <input id="sender" placeholder="Your sending address" />
    <input id="amount" type="number" placeholder="Amount to be sent (10 minimum)" />

    <!-- Fee display badge -->
    <div id="feeDisplay" style="
        margin-top: 8px; 
        font-size: 14px; 
        color: var(--text); 
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: 8px; 
        padding: 6px 12px; 
        width: fit-content;">
      You will receive: 0
    </div>

    <input id="receiver" placeholder="Your receiving address" />

    <button onclick="nextStage()">Continue</button>
  </div>

  <!-- Stage 2 -->
  <div class="box hidden" id="stage2">
    <h3>Send To</h3>
    <div id="destination"></div>
    <button class="copy-btn" onclick="copyText('destination')">Copy Address</button>
    <img id="qr">

    <input id="txid" placeholder="Transaction ID (TXID)">
    <button onclick="submitBridge()">Submit Bridge</button>

    <p style="text-align:center; margin-top:10px;">Request ID: <strong id="reqid"></strong></p>
  </div>

  <!-- Status Check -->
  <div class="box">
    <h3>Check Bridge Status</h3>
    <input id="searchID" placeholder="Request ID">
    <button onclick="checkStatus()">Check</button>
    <div id="statusResult" class="hidden"></div>
  </div>

</div>

<script>
const BACKEND_URL = "https://luce-bridge-backend-production.up.railway.app";
const USDT_RESERVE = "0x348896fF1353966B74d0946F367705E8cf901153";
const LUSDT_BURN = "xBURNomniXEPXXXXXXXXXXXXXXXXbWWsD9";
let requestID = "";

/* ----------------- Stage 1 → Stage 2 ----------------- */
function nextStage() {
  const asset = assetEl().value;
  const amt = +amountEl().value;
  const sender = senderEl().value.trim();
  const receiver = receiverEl().value.trim();

  if (!asset || amt < 10) return alert("Must bridge a minimum of 10 tokens.");

  if (!validateAddress(asset, sender, "sender")) return;
  if (!validateAddress(asset, receiver, "receiver")) return;

  requestID = Math.random().toString(16).slice(2, 8).toUpperCase();
  reqidEl().innerText = requestID;

  destinationEl().innerText = asset === "USDT" ? USDT_RESERVE : LUSDT_BURN;
  qrEl().src = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + destinationEl().innerText;

  stage2().classList.remove("hidden");
  stage2().classList.add("show");
}

/* ----------------- Submit Bridge ----------------- */
function submitBridge() {
  const txid = txidEl().value.trim();
  const asset = assetEl().value;

  if (!txid) return alert("TXID required.");
  if (!validateTxid(asset, txid)) return;

  const payload = {
    requestID,
    asset: asset,
    amount: amountEl().value,
    sender: senderEl().value,
    receiver: receiverEl().value,
    txid
  };

  fetch(BACKEND_URL + "/submitBridge", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.success) {
      alert("Bridge submitted!");
    } else {
      alert("Error: " + (data.error || "Unknown error"));
    }
  })
  .catch(err => alert("Error submitting bridge: " + err));
}

/* ----------------- Check Status ----------------- */
function checkStatus() {
  const id = searchEl().value.trim();
  if (!id) return alert("Enter Request ID.");

  fetch(`https://luce-bridge-backend-production.up.railway.app/checkStatus/${id}`)
    .then(res => res.json())
    .then(data => {
      statusEl().classList.remove("hidden");
      if (data.error) {
        statusEl().innerText = "Error: " + data.error;
      } else {
        // Translate status text for users
        const status = (data.status || "").toLowerCase();
        if (status === "pending") {
          statusEl().innerText = "Pending — please allow up to 24 hours for manual verification and processing.";
        } else if (status === "completed" || status === "complete") {
          statusEl().innerText = "Your bridge request has been completed.";
        } else {
          statusEl().innerText = data.status;
        }
      }
    })
    .catch(err => {
      statusEl().classList.remove("hidden");
      statusEl().innerText = "Error checking status: " + err;
    });
}

/* ----------------- Validation Functions ----------------- */
function validateAddress(asset, addr, role) {
  let regex;

  if (role === "sender") {
    if (asset === "USDT") regex = /^0x[a-fA-F0-9]{40}$/;
    if (asset === "LUSDT") regex = /^x[a-zA-Z0-9]{33}$/;
  } else if (role === "receiver") {
    if (asset === "USDT") regex = /^x[a-zA-Z0-9]{33}$/;
    if (asset === "LUSDT") regex = /^0x[a-fA-F0-9]{40}$/;
  }

  if (!regex.test(addr)) {
    alert(`${role.charAt(0).toUpperCase() + role.slice(1)} address is invalid.`);
    return false;
  }
  return true;
}

function validateTxid(asset, txid) {
  let regex;

  if (asset === "USDT") regex = /^0x[a-fA-F0-9]{64}$/;
  if (asset === "LUSDT") regex = /^[a-fA-F0-9]{64}$/;

  if (!regex.test(txid)) {
    alert(`TXID is invalid.`);
    return false;
  }
  return true;
}

/* ----------------- Theme Button ----------------- */
function toggleTheme() {
  const isDark = document.documentElement.dataset.theme === "dark";
  const newTheme = isDark ? "" : "dark";
  document.documentElement.dataset.theme = newTheme;
  localStorage.setItem("theme", newTheme);
  updateThemeButton();
}

function updateThemeButton() {
  const isDark = document.documentElement.dataset.theme === "dark";
  document.getElementById("themeButton").innerText = isDark ? "Light Mode" : "Dark Mode";
}

/* ----------------- Load saved theme ----------------- */
(function () {
  const saved = localStorage.getItem("theme") === "dark";
  document.documentElement.dataset.theme = saved ? "dark" : "";
  updateThemeButton();
})();

/* ----------------- Helpers ----------------- */
const assetEl = () => document.getElementById("asset");
const senderEl = () => document.getElementById("sender");
const receiverEl = () => document.getElementById("receiver");
const amountEl = () => document.getElementById("amount");
const txidEl = () => document.getElementById("txid");
const destinationEl = () => document.getElementById("destination");
const qrEl = () => document.getElementById("qr");
const stage2 = () => document.getElementById("stage2");
const statusEl = () => document.getElementById("statusResult");
const searchEl = () => document.getElementById("searchID");
const reqidEl = () => document.getElementById("reqid");

function copyText(id) {
  navigator.clipboard.writeText(document.getElementById(id).innerText);
  alert("Copied.");
}

/* ----------------- Fee Calculation ----------------- */
function updateFee() {
  const amt = parseFloat(amountEl().value);
  const asset = assetEl().value;
  const feeDisplay = document.getElementById("feeDisplay");

  if (!amt || amt < 0 || !asset) {
    feeDisplay.innerText = "You will receive: 0";
    return;
  }

  const received = (amt * 0.98).toFixed(2);
  let receivedAsset = "";

  if (asset === "USDT") receivedAsset = "LUSDT";
  if (asset === "LUSDT") receivedAsset = "USDT";

  feeDisplay.innerText = `You will receive: ${received} ${receivedAsset} (after 2% fee)`;
}

amountEl().addEventListener("input", updateFee);
assetEl().addEventListener("change", updateFee);
updateFee();

</script>
</body>
</html>
