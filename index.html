<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>luce.finance Bridge</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon-apple.png">

<style>
@import url('https://fonts.googleapis.com/css2?family=Cardo&family=Josefin+Sans:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap');

:root {
  --bg: rgb(245, 249, 255);
  --card: #ffffff;
  --text: #1f2937;
  --border: #d0d7e2;
  --primary: #2563eb;
  --primary-hover: #1e40af;
  --input-bg: #ffffff;
  --input-text: #1f2937;
  --input-border: #c7d2fe;
}

[data-theme="dark"] {
  --bg: rgb(37, 43, 52);
  --card: #1e2630;
  --text: #e5e7eb;
  --border: #2f3a46;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --input-bg: #2a3441;
  --input-text: #e5e7eb;
  --input-border: #3b4756;
}

/* Apply Montserrat globally */
* { 
  box-sizing: border-box; 
  font-family: 'Montserrat', sans-serif; 
}

body {
  margin: 0;
  padding: clamp(12px, 3vw, 24px);
  background: var(--bg);
  color: var(--text);
}

/* Headers use Cardo, normal weight */
h2, h3 {
  font-family: 'Cardo', serif;
  font-weight: 400;
  text-align: center;
  margin-top: 0;
  margin-bottom: 16px;
}

h2 { font-size: clamp(1.5rem, 4vw, 2.2rem); }
h3 { font-size: clamp(1.1rem, 3vw, 1.4rem); }

.container { max-width: min(92vw, 720px); margin: auto; }

.box {
  background: var(--card);
  border-radius: 14px;
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
  width: 100%;
  transition: transform .3s ease, opacity .3s ease, background .3s ease;
}

input, select {
  width: 100%;
  font-size: 14px;
  padding: 11px;
  border-radius: 10px;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--input-text);
}

select option { background: var(--card); color: var(--text); }

label {
  display: block;
  margin-top: 8px;
  margin-bottom: 6px;
  font-size: 14px;
  font-weight: 400;
  color: var(--text);
  opacity: 0.9;
}

button,
.copy-btn,
.theme-button {
  display: block;
  width: 100%;
  height: 50px;
  line-height: 50px;
  padding: 0 40px;
  margin: 12px auto 0 auto;
  border-radius: 10px;
  border: none;
  box-sizing: border-box;
  font-family: 'Josefin Sans', sans-serif;
  font-size: 14px;
  font-weight: 400;
  text-align: center;
  text-decoration: none !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: rgb(255, 255, 255);
  cursor: pointer;
  background-image: linear-gradient(
    -180deg,
    rgb(102, 186, 241) 0%,
    rgb(51, 130, 209) 96%
  );
  background-repeat: no-repeat !important;
  background-color: rgb(51, 130, 209);
  box-shadow: none;
  transition:
    background-image 0.2s ease,
    transform 0.1s ease;
}

button:hover,
.copy-btn:hover,
.theme-button:hover {
  background-image: linear-gradient(
    -180deg,
    rgb(51, 130, 209) 0%,
    rgb(51, 130, 209) 96%
  );
}

button:active,
.copy-btn:active,
.theme-button:active {
  background-image: linear-gradient(
    -180deg,
    rgba(102, 186, 241, 1) 0%,
    rgba(102, 186, 241, 1) 96%
  );
}

.copy-btn {
  width: auto;
}

.theme-button {
  margin: 0 auto 20px auto;
  width: auto;
}

.hidden { display: none !important; opacity: 0; transform: translateY(10px); }
.show { display: block !important; opacity: 1; transform: translateY(0); }

#stage2 { display: flex; flex-direction: column; align-items: center; }
#destination { text-align: center; font-weight: bold; margin-top: 10px; word-break: break-all; }
#stage2 img { display: block; margin: 16px auto 20px auto; width: min(60vw, 180px); }
#stage2 input { width: 100%; }
#stage2 button {
  margin-bottom: 2px;
}
#stage2 p {
  margin-top: 2px;
  margin-bottom: 0;
}
#stage2 {
  padding-bottom: 12px;
}
#statusResult {
  margin-top: 12px;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  white-space: pre-wrap;
  word-break: break-all;
  width: 100%;
}
</style>
</head>

<body>
<div class="container">

  <button class="theme-button" id="themeButton" onclick="toggleTheme()">Dark Mode</button>
  <h2>luce.finance Bridge</h2>

  <p style="text-align: center; font-family: 'Josefin Sans', sans-serif; font-size: 13px; margin: 0 0 18px 0; color: var(--text); opacity: 0.85; line-height: 1.5;">
    Bridge requests are <strong>manually verified</strong> for security reasons.  
    Please allow up to <strong>24 hours</strong> for completion after submission.
  </p>

  <!-- Stage 1 -->
  <div class="box show" id="stage1">
    <label for="asset">Asset</label>
    <select id="asset">
      <option value="USDT">USDT (BSC → Electra Protocol)</option>
      <option value="LUSDT">LUSDT (Electra Protocol → BSC)</option>
    </select>
    
    <label for="sender" id="senderLabel">Sending Address</label>
    <input id="sender" placeholder="Your sending address" />
    <label for="amount">Amount</label>
    <input id="amount" type="text" inputmode="decimal" placeholder="10 Minimum" autocomplete="off" />

    <div id="feeDisplay" style="margin-top: 8px; font-size: 14px; color: var(--text); background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 6px 12px; width: fit-content;">
      You will receive:
    </div>

    <label for="receiver" id="receiverLabel">Receiving Address</label>
    <input id="receiver" placeholder="Your receiving address" />
    <button onclick="nextStage()">Continue</button>
  </div>

  <!-- Stage 2 -->
  <div class="box hidden" id="stage2">
    <h3>Send To</h3>
    <div id="destination"></div>
    <button class="copy-btn" onclick="copyText('destination')">Copy Address</button>
    <img id="qr">
    <label for="txid">Transaction ID</label>
    <input id="txid" placeholder="Your TXID">
    <button onclick="submitBridge()">Submit Bridge</button>
    <p style="text-align:center; margin-top:10px;">Request ID: <strong id="reqid"></strong></p>
  </div>

  <!-- Status Check -->
  <div class="box">
  <h3>Check Bridge Status</h3>
  <label for="searchID">Request ID</label>
  <input id="searchID" placeholder="Your Request ID">
  <button onclick="checkStatus()">Check</button>
</div>

<script>
const BACKEND_URL = "https://luce-bridge-backend-production.up.railway.app";
const USDT_RESERVE = "0x348896fF1353966B74d0946F367705E8cf901153";
const LUSDT_BURN = "xBURNomniXEPXXXXXXXXXXXXXXXXbWWsD9";
let requestID = "";

/* ----------------- Responsive Placeholders ----------------- */
function updateAddressPlaceholders() {
  const asset = assetEl().value;

  const senderLabel = document.getElementById("senderLabel");
  const receiverLabel = document.getElementById("receiverLabel");

  if (asset === "USDT") {
    // USDT → Electra
    senderLabel.innerText = "Sending Address (Binance Smart Chain)";
    receiverLabel.innerText = "Receiving Address (Electra Protocol)";

    senderEl().placeholder = "Your BSC Address";
    receiverEl().placeholder = "Your OmniXEP Address";
  } 
  else if (asset === "LUSDT") {
    // Electra → USDT
    senderLabel.innerText = "Sending Address (Electra Protocol)";
    receiverLabel.innerText = "Receiving Address (Binance Smart Chain)";

    senderEl().placeholder = "Your OmniXEP Address";
    receiverEl().placeholder = "Your BSC Address";
  } 
  else {
    senderLabel.innerText = "Sending Address";
    receiverLabel.innerText = "Receiving Address";

    senderEl().placeholder = "Your Sending Address";
    receiverEl().placeholder = "Your Receiving Address";
  }
}

/* ----------------- Uniform Button Feedback ----------------- */
function showBtnFeedback(btn, message) {
  if (!btn) return;
  const original = btn.innerText;
  btn.innerText = message;
  btn.style.opacity = 1;
  btn.style.cursor = "pointer";
  setTimeout(() => { btn.innerText = original; }, 2000);
}

/* ----------------- Validation Functions ----------------- */
function validateAddress(asset, addr, role, btn) {
  const isSender = role === "sender";

  if (!addr) {
    showBtnFeedback(btn, `${isSender ? "Sending" : "Receiving"} Address Required`);
    return false;
  }

  // Expected formats
  const expectBSC = (asset === "USDT" && isSender) || (asset === "LUSDT" && !isSender);
  const expectElectra = !expectBSC;

  // Regex
  const bscRegex = /^0x[a-fA-F0-9]{40}$/;
  const electraRegex = /^x[a-zA-Z0-9]{33}$/;

  // Incomplete checks
  if (expectBSC && addr.startsWith("0x") && addr.length < 42) {
    showBtnFeedback(btn, "BSC Address Incomplete");
    return false;
  }

  if (expectElectra && addr.startsWith("x") && addr.length < 34) {
    showBtnFeedback(btn, "OmniXEP Address Incomplete");
    return false;
  }

  // Wrong chain type
  if (expectBSC && !bscRegex.test(addr)) {
    showBtnFeedback(btn, "BSC Address Invalid");
    return false;
  }

  if (expectElectra && !electraRegex.test(addr)) {
    showBtnFeedback(btn, "OmniXEP Address Invalid");
    return false;
  }

  return true;
}

function validateTxid(asset, txid) {
  const btn = document.querySelector('#stage2 button[onclick="submitBridge()"]');
  const regex = asset==="USDT" ? /^0x[a-fA-F0-9]{64}$/ : /^[a-fA-F0-9]{64}$/;
  if (!regex.test(txid)) { showBtnFeedback(btn, "Transaction ID Invalid"); return false; }
  return true;
}

/* ----------------- Secure Request ID Generation ----------------- */
function generateSecureRequestID() {
  // 6 bytes = 48 bits of entropy → 12 hex characters
  const array = new Uint8Array(6);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
}

/* ----------------- Stage 1 → Stage 2 ----------------- */
function validateStage1() {
  const asset = assetEl().value;
  const amt = +amountEl().value;
  const sender = senderEl().value.trim();
  const receiver = receiverEl().value.trim();
  const btn = document.querySelector('#stage1 button');

if (!asset) {
  showBtnFeedback(btn, "Select an asset");
  return false;
}

if (!validateAddress(asset, sender, "sender", btn)) return false;

if (!amt || amt < 10) {
  showBtnFeedback(btn, "Minimum 10 Tokens");
  return false;
}

if (!amt || amt > 1_000_000_000) {
  showBtnFeedback(btn, "Amount Exceeds Maximum");
  return false;
}


if (!validateAddress(asset, receiver, "receiver", btn)) return false;

  return true;
}

function nextStage() {
  if (!validateStage1()) return;

  requestID = generateSecureRequestID();
  reqidEl().innerText = requestID;

  destinationEl().innerText = assetEl().value==="USDT" ? USDT_RESERVE : LUSDT_BURN;
  qrEl().src = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data="+destinationEl().innerText;

  stage2().classList.remove("hidden"); stage2().classList.add("show");

  const btn = document.querySelector('#stage1 button');
  btn.disabled=true; btn.innerText="Request ID Generated"; btn.style.opacity=0.5; btn.style.cursor="not-allowed";

  [assetEl(),senderEl(),receiverEl(),amountEl()].forEach(input=>{
    input.disabled=true; input.style.background="var(--input-bg)"; input.style.color="var(--input-text)"; input.style.cursor="not-allowed";
  });
}

/* ----------------- Submit Bridge ----------------- */
function submitBridge() {
  const txid = txidEl().value.trim(); const asset = assetEl().value;
  const btn = document.querySelector('#stage2 button[onclick="submitBridge()"]');

  if (!txid) { showBtnFeedback(btn,"Transaction ID Required"); return; }
  if (!validateTxid(asset,txid)) return;

  const payload = { requestID, asset, amount: amountEl().value, sender: senderEl().value, receiver: receiverEl().value, txid };
  btn.style.width = btn.offsetWidth + "px";

  fetch(BACKEND_URL+"/submitBridge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      btn.innerText="Bridge Submitted"; btn.disabled=true; btn.style.opacity=0.5; btn.style.cursor="not-allowed";
      txidEl().disabled=true; txidEl().style.background="var(--input-bg)"; txidEl().style.color="var(--input-text)"; txidEl().style.cursor="not-allowed";
    }else showBtnFeedback(btn,data.error||"Bridge submission failed. Please try again.");
  })
  .catch(err=>showBtnFeedback(btn,"Network error. Please try again."));
}

/* ----------------- Copy Address ----------------- */
function copyText(id){
  const btn=document.querySelector('.copy-btn'); const original=btn.innerText;
  btn.style.width=btn.offsetWidth+"px";
  navigator.clipboard.writeText(document.getElementById(id).innerText);
  btn.innerText="Copied";
  setTimeout(()=>{btn.innerText=original; btn.style.width="";},2000);
}

/* ----------------- Check Status (button feedback style) ----------------- */
function checkStatus() {
  const btn = document.querySelector('.box:last-of-type button'); // the Check button
  const id = searchEl().value.trim();

  if (!id) {
    showBtnFeedback(btn, "Enter Request ID");
    return;
  }

  fetch(`${BACKEND_URL}/checkStatus/${id}`)
    .then(res => res.json())
    .then(data => {
      const status = (data.status || "").toLowerCase();

      // Treat backend "Request ID not found" or any error as invalid
      if (status === "request id not found" || data.error) {
        showBtnFeedback(btn, "Request ID Invalid");
        return;
      }

      // Handle normal statuses
      if (status === "pending") {
        showBtnFeedback(btn, "Pending");
      } else if (status === "completed" || status === "complete") {
        showBtnFeedback(btn, "Completed");
      } else {
        // Any other unknown message
        showBtnFeedback(btn, data.status + ".");
      }
    })
    .catch(err => {
      showBtnFeedback(btn, "Error checking status. Please try again.");
    });
}

/* ----------------- Theme ----------------- */
function toggleTheme(){
  const isDark=document.documentElement.dataset.theme==="dark";
  document.documentElement.dataset.theme=isDark?"":"dark";
  localStorage.setItem("theme",isDark?"":"dark");
  updateThemeButton();
}

function updateThemeButton(){
  document.getElementById("themeButton").innerText=document.documentElement.dataset.theme==="dark"?"Light Mode":"Dark Mode";
}

(function(){
  document.documentElement.dataset.theme=localStorage.getItem("theme")==="dark"?"dark":"";
  updateThemeButton();
})();

/* ----------------- Helpers ----------------- */
const assetEl=()=>document.getElementById("asset");
const senderEl=()=>document.getElementById("sender");
const receiverEl=()=>document.getElementById("receiver");
const amountEl=()=>document.getElementById("amount");
const txidEl=()=>document.getElementById("txid");
const destinationEl=()=>document.getElementById("destination");
const qrEl=()=>document.getElementById("qr");
const stage2=()=>document.getElementById("stage2");
const statusEl=()=>document.getElementById("statusResult");
const searchEl=()=>document.getElementById("searchID");
const reqidEl=()=>document.getElementById("reqid");
document.addEventListener("DOMContentLoaded", () => {
  updateAddressPlaceholders();
});

/* ----------------- Amount input hard limits ----------------- */
const MAX_INTEGER_DIGITS = 10; // up to 1,000,000,000
const MAX_DECIMALS = 2;
const MIN_AMOUNT = 10;

amountEl().addEventListener("beforeinput", (e) => {
  const el = amountEl();
  const value = el.value;

  // Allow deletions
  if (e.inputType && e.inputType.startsWith("delete")) return;

  // Some mobile keyboards send null
  if (e.data === null) return;

  const next =
    value.slice(0, el.selectionStart) +
    e.data +
    value.slice(el.selectionEnd);

  // Only digits and one decimal
  if (!/^[0-9.]*$/.test(next)) {
    e.preventDefault();
    return;
  }

  const parts = next.split(".");

  // Prevent starting with 0 (except when next is just "0" itself, which we block anyway later)
  if (parts[0].startsWith("0") && parts[0].length > 1) {
    e.preventDefault();
    return;
  }

  // Prevent starting with a decimal
  if (next.startsWith(".")) {
    e.preventDefault();
    return;
  }

  // No multiple decimals
  if (parts.length > 2) {
    e.preventDefault();
    return;
  }

  // Limit integer digits
  if (parts[0].length > MAX_INTEGER_DIGITS) {
    e.preventDefault();
    return;
  }

  // Limit decimal places
  if (parts[1] && parts[1].length > MAX_DECIMALS) {
    e.preventDefault();
    return;
  }

  const numeric = Number(next);
  if (!isNaN(numeric) && numeric > 1_000_000_000) {
    e.preventDefault();
    return;
  }
});

amountEl().addEventListener("input", () => {
  let v = amountEl().value;

  // Strip invalid characters (paste safety)
  v = v.replace(/[^0-9.]/g, "");

  const parts = v.split(".");

  // Only one decimal point allowed
  if (parts.length > 2) {
    v = parts[0] + "." + parts.slice(1).join("");
  }

  // Enforce integer and decimal limits
  parts[0] = parts[0].slice(0, MAX_INTEGER_DIGITS);
  if (parts[1]) parts[1] = parts[1].slice(0, MAX_DECIMALS);

  // Remove any leading zeros
  parts[0] = parts[0].replace(/^0+/, "");

  amountEl().value = parts.join(".");

  // Clamp minimum to 10 in fee display
  updateFee();
});

/* ----------------- Fee ----------------- */
function updateFee() {
  const feeDisplay = document.getElementById("feeDisplay");
  const asset = assetEl().value;

  const raw = amountEl().value;
  const amt = Number(raw);

  const feeRate = 0.02;
  let displayAmount = "0.00";

  // Only calculate fee if amount is >= 10
  if (!isNaN(amt) && amt >= 10) {
    displayAmount = (amt * (1 - feeRate)).toFixed(2);
  }

  // Determine output denomination
  const outAsset = asset === "USDT" ? "LUSDT" : asset === "LUSDT" ? "USDT" : "";

  // Update fee display
  feeDisplay.innerHTML = `
    You will receive:
    <strong>${displayAmount}${outAsset ? " " + outAsset : ""}</strong>
    <div class="fee-note">Includes 2% protocol fee</div>
  `;
}

// Update fee when asset changes
assetEl().addEventListener("change", () => {
  updateFee();
  updateAddressPlaceholders();
});

// Update fee when amount changes
amountEl().addEventListener("input", () => {
  updateFee();
});

// Initialize on page load
document.addEventListener("DOMContentLoaded", () => {
  updateFee();
});
</script>
</body>
</html>
